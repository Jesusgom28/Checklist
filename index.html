<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Offline Card Checklist</title>
<style>
  body { font-family: Arial, sans-serif; background:#0f1115; color:#e7e7e7; margin:0; }
  header { padding:14px 16px; position: sticky; top:0; background:#0f1115; border-bottom:1px solid #222; z-index:10; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  input[type="text"] { padding:8px 10px; border-radius:10px; border:1px solid #333; background:#141824; color:#e7e7e7; width:260px; }
  select, button { padding:8px 10px; border-radius:10px; border:1px solid #333; background:#141824; color:#e7e7e7; cursor:pointer; }
  .stats { opacity:.9; font-size:13px; }
  main { padding:14px 16px; }
  .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap:12px; }
  .card {
    position: relative; background:#141824; border:1px solid #222; border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:8px; }
  .thumb { width:100%; aspect-ratio: 3/4; border-radius:12px; background:#0b0d12; object-fit:cover; }
  .name { font-size:13px; line-height:1.2; font-weight:600; }
  .meta { font-size:12px; opacity:.8; white-space:pre-wrap; }
  .check { display:flex; gap:8px; align-items:center; user-select:none; }
  .check input { width:18px; height:18px; }
  .divider { height:1px; background:#222; margin:10px 0; }
  .muted { opacity:.7; }

.badge{position:absolute;top:10px;left:10px;background:#444;color:#fff;font-size:12px;padding:4px 8px;border-radius:999px;opacity:0.9;}
</style>
</head>
<body>
<header>
  <div class="row">
    <input id="search" type="text" placeholder="Search character..." />
    <select id="ownedFilter">
      <option value="all">All</option>
      <option value="owned">Owned</option>
      <option value="missing">Missing</option>
    </select>
    <select id="setFilter">
      <option value="">All Sets</option>
      <option value="151">151</option><option value="Ancient Origins">Ancient Origins</option><option value="Ascended Heroes">Ascended Heroes</option><option value="Astral Radiance">Astral Radiance</option><option value="BREAKpoint">BREAKpoint</option><option value="BREAKthrough">BREAKthrough</option><option value="Battle Styles">Battle Styles</option><option value="Black Bolt">Black Bolt</option><option value="Boundaries Crossed">Boundaries Crossed</option><option value="Brilliant Stars">Brilliant Stars</option><option value="Burning Shadows">Burning Shadows</option><option value="Celebrations">Celebrations</option><option value="Celestial Storm">Celestial Storm</option><option value="Champion's Path">Champion's Path</option><option value="Chilling Reign">Chilling Reign</option><option value="Cosmic Eclipse">Cosmic Eclipse</option><option value="Crimson Invasion">Crimson Invasion</option><option value="Crown Zenith">Crown Zenith</option><option value="Cyrus Premium Tournament Collection">Cyrus Premium Tournament Collection</option><option value="Darkness Ablaze">Darkness Ablaze</option><option value="Destined Rivals">Destined Rivals</option><option value="Dragon Majesty">Dragon Majesty</option><option value="Evolutions">Evolutions</option><option value="Evolving Skies">Evolving Skies</option><option value="Extra Battle Day">Extra Battle Day</option><option value="Fates Collide">Fates Collide</option><option value="Flashfire">Flashfire</option><option value="Forbidden Light">Forbidden Light</option><option value="Furious Fists">Furious Fists</option><option value="Fusion Strike">Fusion Strike</option><option value="Guardians Rising">Guardians Rising</option><option value="Hidden Fates">Hidden Fates</option><option value="Iono Premium Tournament Collection">Iono Premium Tournament Collection</option><option value="Journey Together">Journey Together</option><option value="Klara Premium Tournament Collection">Klara Premium Tournament Collection</option><option value="Limited Collection Master Battle Set">Limited Collection Master Battle Set</option><option value="Lost Origin">Lost Origin</option><option value="Lost Thunder">Lost Thunder</option><option value="Lost thunder">Lost thunder</option><option value="Marnie Premium Tournament Collection">Marnie Premium Tournament Collection</option><option value="Mega Evolution">Mega Evolution</option><option value="Noble Victories">Noble Victories</option><option value="Obsidian Flames">Obsidian Flames</option><option value="Paldea Evolved">Paldea Evolved</option><option value="Paldean Fates">Paldean Fates</option><option value="Paradox Rift">Paradox Rift</option><option value="Phantasmal Flames">Phantasmal Flames</option><option value="Phantom Forces">Phantom Forces</option><option value="Plasma Blast">Plasma Blast</option><option value="Plasma Freeze">Plasma Freeze</option><option value="Plasma Storm">Plasma Storm</option><option value="Pokémon GO">Pokémon GO</option><option value="Pokémon GO Special Edition - Team Instinct">Pokémon GO Special Edition - Team Instinct</option><option value="Pokémon GO Special Edition - Team Mystic">Pokémon GO Special Edition - Team Mystic</option><option value="Pokémon GO Special Edition - Team Valor">Pokémon GO Special Edition - Team Valor</option><option value="Premium Trainer's XY Collection">Premium Trainer's XY Collection</option><option value="Primal Clash">Primal Clash</option><option value="Prismatic Evolutions">Prismatic Evolutions</option><option value="Professor Juniper Premium Tournament Collection">Professor Juniper Premium Tournament Collection</option><option value="Rebel Clash">Rebel Clash</option><option value="Roaring Skies">Roaring Skies</option><option value="Rocket 20th Anniversary">Rocket 20th Anniversary</option><option value="SM12a GX Tag All Stars">SM12a GX Tag All Stars</option><option value="SMP2 Great Detective Pikachu">SMP2 Great Detective Pikachu</option><option value="Scarlet & Violet">Scarlet & Violet</option><option value="Shining Fates">Shining Fates</option><option value="Shining Legends">Shining Legends</option><option value="Shining Legends Sealed Game">Shining Legends Sealed Game</option><option value="Shrouded Fable">Shrouded Fable</option><option value="Silver Temepst">Silver Temepst</option><option value="Silver Tempest">Silver Tempest</option><option value="Steam Siege">Steam Siege</option><option value="Stellar Crown">Stellar Crown</option><option value="Sun & Moon">Sun & Moon</option><option value="Surging Sparks">Surging Sparks</option><option value="Sword & Shield">Sword & Shield</option><option value="Team Up">Team Up</option><option value="Temporal Forces">Temporal Forces</option><option value="Twilight Masquerade">Twilight Masquerade</option><option value="Ultra Prism">Ultra Prism</option><option value="Unbroken Bonds">Unbroken Bonds</option><option value="Unified Minds">Unified Minds</option><option value="Vivid Voltage">Vivid Voltage</option><option value="White Flare">White Flare</option>
    </select>
    <select id="rarityFilter">
      <option value="">All Types/Rarity</option>
      <option value="-">-</option><option value="GG Ultra Rare">GG Ultra Rare</option><option value="Promo">Promo</option><option value="SR">SR</option><option value="Special Illustration Rare">Special Illustration Rare</option><option value="TG Ultra Rare">TG Ultra Rare</option><option value="Ultra Rare">Ultra Rare</option>
    </select>
    <select id="sortMode">
      <option value="name_asc">Name A→Z</option>
      <option value="name_desc">Name Z→A</option>
      <option value="set_num">Set + Number</option>
    </select>
    <button id="exportBtn">Export</button>
    <button id="importBtn">Import</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </div>
  <div class="divider"></div>
  <div class="row stats">
    <div id="stats"></div>
    <div class="muted">Offline ✓  |  Collection: elitefourum_full_art_supporters</div>
  </div>
</header>

<main>
  <div class="grid" id="grid"></div>
</main>

<script>
const COLLECTION_KEY = "elitefourum_full_art_supporters";
  const STORAGE_KEY = "owned_cards_" + COLLECTION_KEY; // persists across rebuilds

  // PASTEEXISTING CARDS ARRAY HERE
  // Example:
  // const CARDS = [...];
  const CARDS = /* <-- paste your big array here --> */ [];

  // This will be loaded from image_overrides.json
  let IMAGE_OVERRIDES = {};

  async function loadImageOverrides() {
    try {
      // This must be in the same folder level as index.html
      // (so /Checklist/image_overrides.json if your site is /Checklist/)
      const res = await fetch("./image_overrides.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      IMAGE_OVERRIDES = await res.json();
    } catch (e) {
      console.warn("Could not load image_overrides.json (continuing without overrides).", e);
      IMAGE_OVERRIDES = {};
    }
  }

  let owned = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));

  const grid = document.getElementById("grid");
  const search = document.getElementById("search");
  const ownedFilter = document.getElementById("ownedFilter");
  const setFilter = document.getElementById("setFilter");
  const rarityFilter = document.getElementById("rarityFilter");
  const sortMode = document.getElementById("sortMode");
  const stats = document.getElementById("stats");

  // Force default sort to Name A→Z on every open
  sortMode.value = "name_asc";

  function getImgSrc(c) {
    // 1) overrides by UID (this fixes cards like Alola Friends where image/image_local are blank)
    const override = IMAGE_OVERRIDES && c && c.uid ? IMAGE_OVERRIDES[c.uid] : "";
    if (override) return override;

    // 2) local file path from cards data
    if (c.image_local && c.image_local.length) return c.image_local;

    // 3) fallback to remote image URL
    return c.image || "";
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(owned)));
    renderStats();
  }

  function renderStats() {
    const total = CARDS.length;
    let have = 0;
    let noImg = 0;

    CARDS.forEach(c => {
      if (owned.has(c.uid)) have++;
      const s = getImgSrc(c);
      if (!s) noImg++;
    });

    const shown = getFilteredSorted().length;
    stats.textContent =
      "Shown: " + shown +
      "   Owned: " + have + " / " + total +
      "   (Missing: " + (total - have) + ")" +
      "   (No image: " + noImg + ")";
  }

  function normalize(s) {
    return (s || "").toString().toLowerCase();
  }

  function cmpSetNum(a, b) {
    const sa = a.set || "";
    const sb = b.set || "";
    if (sa !== sb) return sa.localeCompare(sb);

    const na = a.card_number || "";
    const nb = b.card_number || "";
    return na.localeCompare(nb, undefined, { numeric: true, sensitivity: "base" });
  }

  function getFilteredSorted() {
    const q = normalize(search.value).trim();
    const ownMode = ownedFilter.value;
    const setVal = setFilter.value;
    const rarVal = rarityFilter.value;

    let arr = CARDS.filter(c => {
      const name = normalize(c.display_name || c.name || "");
      if (q && !name.includes(q)) return false;
      if (setVal && c.set !== setVal) return false;
      if (rarVal && c.rarity !== rarVal) return false;

      const isOwned = owned.has(c.uid);
      if (ownMode === "owned" && !isOwned) return false;
      if (ownMode === "missing" && isOwned) return false;
      return true;
    });

    const mode = sortMode.value;
    if (mode === "name_asc") {
      arr.sort((a, b) => (a.name || "").localeCompare(b.name || "", undefined, { sensitivity: "base" }));
    } else if (mode === "name_desc") {
      arr.sort((a, b) => (b.name || "").localeCompare(a.name || "", undefined, { sensitivity: "base" }));
    } else {
      arr.sort(cmpSetNum);
    }

    return arr;
  }

  function fillSelectOptionsFromCards() {
    // Only fill if your HTML didn't already hard-code options.
    // If your select already has many options, this will still be safe.

    const uniqueSets = Array.from(new Set(CARDS.map(c => c.set).filter(Boolean))).sort((a, b) => a.localeCompare(b));
    const uniqueRarities = Array.from(new Set(CARDS.map(c => c.rarity).filter(Boolean))).sort((a, b) => a.localeCompare(b));

    // preserve current selection
    const currentSet = setFilter.value;
    const currentRarity = rarityFilter.value;

    // If the select is basically empty (or only has the "All" option), populate it.
    if (setFilter.options.length <= 1) {
      uniqueSets.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        setFilter.appendChild(opt);
      });
    }

    if (rarityFilter.options.length <= 1) {
      uniqueRarities.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        rarityFilter.appendChild(opt);
      });
    }

    // restore if still present
    setFilter.value = currentSet;
    rarityFilter.value = currentRarity;
  }

  function render() {
    const arr = getFilteredSorted();
    grid.innerHTML = "";

    arr.forEach(c => {
      const div = document.createElement("div");
      div.className = "card";

      const img = document.createElement("img");
      img.className = "thumb";
      img.loading = "lazy";
      img.alt = c.display_name || c.name || "Card";

      const src = getImgSrc(c);
      if (src) {
        img.src = src;
        img.style.display = "";
      } else {
        img.style.display = "none";
      }

      // If the image fails, hide it (prevents broken icon)
      img.onerror = () => {
        img.style.display = "none";
      };

      const n = document.createElement("div");
      n.className = "name";
      n.textContent = c.display_name || c.name || "";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${c.set || ""} • ${c.card_number || ""} • ${c.rarity || ""}`.replace(/\s•\s•\s/g, " • ").trim();

      const label = document.createElement("label");
      label.className = "owned-label";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = owned.has(c.uid);

      cb.addEventListener("change", () => {
        if (cb.checked) owned.add(c.uid);
        else owned.delete(c.uid);
        save();
        render(); // refresh “owned/missing” filter view immediately
      });

      label.appendChild(cb);
      label.appendChild(document.createTextNode(" Owned"));

      div.appendChild(img);
      div.appendChild(n);
      div.appendChild(meta);
      div.appendChild(label);

      grid.appendChild(div);
    });

    renderStats();
  }

  [search, ownedFilter, setFilter, rarityFilter, sortMode].forEach(el => {
    el.addEventListener("input", render);
    el.addEventListener("change", render);
  });

  document.getElementById("exportBtn").addEventListener("click", () => {
    const payload = {
      collection: COLLECTION_KEY,
      owned: Array.from(owned),
      exported_at: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `owned_progress_elitefourum_full_art_supporters.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("importBtn").addEventListener("click", () => {
    document.getElementById("importFile").click();
  });

  document.getElementById("importFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!data.owned || !Array.isArray(data.owned)) throw new Error("Invalid progress file.");
        if (data.collection && data.collection !== COLLECTION_KEY) {
          if (!confirm("Progress is from a different collection. Import anyway?")) return;
        }
        owned = new Set(data.owned);
        save();
        render();
        alert("Progress imported!");
      } catch (err) {
        alert("Import failed: " + err.message);
      }
    };
    reader.readAsText(file);
    e.target.value = "";
  });

  // IMPORTANT: load overrides FIRST, then render
  (async function init() {
    await loadImageOverrides();
    fillSelectOptionsFromCards();
    render();
  })();
</script>
</body>
</html>
